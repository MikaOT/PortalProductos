<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat en tiempo real</title>
  <link rel="stylesheet" href="/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* Layout chat + DM */
    .chat-layout {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 1rem;
    }

    @media (max-width: 900px) {
      .chat-layout {
        grid-template-columns: 1fr;
      }
    }

    #messages,
    #dmMessages {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 60vh;
      overflow: auto;
    }

    #dmPanel {
      display: none;
    }

    #dmPanel.active {
      display: block;
    }

    .username-link {
      font-weight: 700;
      text-decoration: underline;
      cursor: pointer;
    }

    .muted {
      color: #9fb0d0;
      font-size: .9rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>Chat en tiempo real</h1>
    <nav>
      <a href="/">Volver</a>
    </nav>
  </header>

  <main>
    <div class="chat-layout">
      <!-- Chat global -->
      <section class="card">
        <h2>Global</h2>
        <ul id="messages"></ul>
        <div class="typing" id="typing"></div>
        <form id="chatForm">
          <input id="message" autocomplete="off" placeholder="Escribe un mensaje..." />
          <button>Enviar</button>
        </form>
        <p class="muted">Tip: haz clic en el <strong>nombre</strong> de alguien para abrir un chat privado.</p>
      </section>

      <!-- Panel de DM -->
      <section id="dmPanel" class="card">
        <div class="toolbar">
          <h2>Privado con <span id="dmWithName">‚Äî</span></h2>
          <button id="dmClose" type="button">Cerrar</button>
        </div>
        <ul id="dmMessages"></ul>
        <form id="dmForm" class="mt-2">
          <input id="dmInput" autocomplete="off" placeholder="Mensaje privado..." />
          <button>Enviar</button>
        </form>
      </section>
    </div>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // === Autenticaci√≥n b√°sica ===
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Debes iniciar sesi√≥n');
      window.location.href = '/';
    }

    // === Conexi√≥n con el servidor ===
    const socket = io({
      auth: { token },
      transports: ['websocket'] // m√°s estable en producci√≥n
    });
    
    socket.on('connect_error', async (err) => {
      console.error('‚ùå Error socket:', err.message);

      if (err.message === 'jwt expired') {
        console.log('‚ö†Ô∏è Token expirado. Intentando renovar...');
        try {
          const res = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });

          if (!res.ok) throw new Error('No se pudo renovar token');
          const data = await res.json();
          localStorage.setItem('token', data.newToken);
          socket.auth.token = data.newToken;
          socket.connect(); // reconecta con el nuevo token
          console.log('üîÑ Token renovado y socket reconectado');
        } catch (refreshErr) {
          console.error('‚ùå Error al renovar token:', refreshErr);
          alert('Sesi√≥n expirada. Vuelve a iniciar sesi√≥n.');
          localStorage.removeItem('token');
          window.location.href = '/';
        }
      } else {
        alert('Error de conexi√≥n o autenticaci√≥n en socket.');
      }
    });


    // === Elementos del DOM ===
    const messages = document.getElementById('messages');
    const form = document.getElementById('chatForm');
    const input = document.getElementById('message');
    const typing = document.getElementById('typing');

    const dmPanel = document.getElementById('dmPanel');
    const dmWithName = document.getElementById('dmWithName');
    const dmMessages = document.getElementById('dmMessages');
    const dmForm = document.getElementById('dmForm');
    const dmInput = document.getElementById('dmInput');
    const dmClose = document.getElementById('dmClose');

    let currentDMUserId = null;
    socket.userId = null;

    // === Inicializaci√≥n ===
    socket.on('connect', () => {
      socket.emit('getUserInfo');
    });

    socket.on('userInfo', (data) => {
      socket.userId = data.id;
      console.log('üü¢ Conectado como:', data.username);
    });

    // === Historial del chat global ===
    window.addEventListener('load', () => {
      const saved = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      if (saved.length > 0) saved.forEach(addMsg);
    });

    socket.on('history', (history) => {
      messages.innerHTML = '';
      history.forEach(addMsg);
      localStorage.setItem('chatHistory', JSON.stringify(history));
    });

    // === Mensajes globales ===
    socket.on('chat:message', (msg) => {
      addMsg(msg);
      const saved = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      saved.push(msg);
      localStorage.setItem('chatHistory', JSON.stringify(saved));
    });

    socket.on('chat:typing', (username) => {
      typing.textContent = `${username} est√° escribiendo...`;
      setTimeout(() => typing.textContent = '', 1000);
    });

    // === Enviar mensaje global ===
    input.addEventListener('input', () => socket.emit('chat:typing'));
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      socket.emit('chat:message', text);
      input.value = '';
    });

    // === Renderizar mensaje global ===
    function addMsg(msg) {
      const li = document.createElement('li');
      li.classList.add('message');
      if (msg.senderId === socket.userId) li.classList.add('self');

      const date = new Date(msg.createdAt || msg.time);
      const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const isAdmin = msg.senderName?.toLowerCase() === 'admin';
      li.innerHTML = `
        <span class="msg-time">[${time}]</span>
        <span class="username ${isAdmin ? 'admin' : 'username-link'}" data-user="${msg.senderId}" data-name="${msg.senderName}">
          ${msg.senderName}:
        </span>
        <span class="msg-text">${msg.isDeleted ? 'üóëÔ∏è Mensaje eliminado' : escapeHTML(msg.text)}</span>
      `;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    // === Clic en nombre ‚Üí abrir DM ===
    messages.addEventListener('click', (e) => {
      const a = e.target.closest('.username-link');
      if (!a) return;
      const toUserId = a.dataset.user;
      const name = a.dataset.name || 'Usuario';
      openDM(toUserId, name);
    });

    function openDM(toUserId, name) {
      currentDMUserId = toUserId;
      dmWithName.textContent = name;
      dmPanel.classList.add('active');
      dmMessages.innerHTML = '';
      socket.emit('dm:history', { withUserId: toUserId });
    }

    dmClose.addEventListener('click', () => {
      currentDMUserId = null;
      dmPanel.classList.remove('active');
      dmMessages.innerHTML = '';
    });

    // === Historial y mensajes privados ===
    socket.on('dm:history', ({ withUserId, messages: list }) => {
      if (currentDMUserId !== withUserId) return;
      dmMessages.innerHTML = '';
      list.forEach(addDMMsg);
      dmMessages.scrollTop = dmMessages.scrollHeight;
    });

    socket.on('dm:message', (doc) => {
      const ids = roomToPair(doc.room);
      if (!ids || !currentDMUserId) return;
      if (ids.includes(currentDMUserId)) {
        addDMMsg(doc);
        dmMessages.scrollTop = dmMessages.scrollHeight;
      }
    });

    dmForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = dmInput.value.trim();
      if (!text || !currentDMUserId) return;
      socket.emit('dm:message', { toUserId: currentDMUserId, text });
      dmInput.value = '';
    });

    function addDMMsg(msg) {
      const li = document.createElement('li');
      li.classList.add('message');
      if (msg.senderId === socket.userId) li.classList.add('self');

      const date = new Date(msg.createdAt || msg.time);
      const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      li.innerHTML = `
        <span class="msg-time">[${time}]</span>
        <strong>${msg.senderName}:</strong> ${escapeHTML(msg.text)}
      `;
      dmMessages.appendChild(li);
    }

    function roomToPair(room) {
      if (!room || !room.startsWith('dm:')) return null;
      return room.split(':').slice(1);
    }

    function escapeHTML(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }
  </script>
</body>

</html>